<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blended-zio/blog/rss.xml" title="Blended ZIO Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blended-zio/blog/atom.xml" title="Blended ZIO Blog Atom Feed"><title data-react-helmet="true">Blended ZIO Core | Blended ZIO</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Blended ZIO Core | Blended ZIO"><meta data-react-helmet="true" name="description" content="Functionality that is required by all blended containers."><meta data-react-helmet="true" property="og:description" content="Functionality that is required by all blended containers."><meta data-react-helmet="true" property="og:url" content="https://blended-zio.github.io/blended-zio/blended-zio/docs/core/index"><link data-react-helmet="true" rel="shortcut icon" href="/blended-zio/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blended-zio.github.io/blended-zio/blended-zio/docs/core/index"><link rel="stylesheet" href="/blended-zio/styles.b0c1b4e5.css">
<link rel="preload" href="/blended-zio/styles.d9a0b84b.js" as="script">
<link rel="preload" href="/blended-zio/runtime~main.29ca2af9.js" as="script">
<link rel="preload" href="/blended-zio/main.7e8fceba.js" as="script">
<link rel="preload" href="/blended-zio/1.19696370.js" as="script">
<link rel="preload" href="/blended-zio/43.06c114df.js" as="script">
<link rel="preload" href="/blended-zio/44.e6cb2f23.js" as="script">
<link rel="preload" href="/blended-zio/935f2afb.5f2d17e5.js" as="script">
<link rel="preload" href="/blended-zio/42.26aa1c8b.js" as="script">
<link rel="preload" href="/blended-zio/18c3d7cc.6a65a9d1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/blended-zio/"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blended-zio/docs/">Docs</a><a class="navbar__item navbar__link" href="/blended-zio/blog">Blog</a><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/blended-zio/"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blended-zio/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blended-zio/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Overview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blended-zio/docs/">Blended Use Cases</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blended-zio/docs/container">Service based containers</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Modules</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/blended-zio/docs/core/index">Blended ZIO Core</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">JMX</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blended-zio/docs/jmx/index">Blended ZIO JMX</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blended-zio/docs/jmx/mbeanserver">A simple MBean Server Facade</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blended-zio/docs/jmx/mbeanpublisher">MBean Publisher</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/blended-zio/docs/jmx/servicemetrics">Service Metrics</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/blended-zio/docs/streams/index">Blended ZIO Streams</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Blended ZIO Core</h1></header><div class="markdown"><p>Functionality that is required by all <em>blended</em> containers.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="configuring-blended-containers"></a>Configuring Blended Containers<a class="hash-link" href="#configuring-blended-containers" title="Direct link to heading">#</a></h2><p>As outlined [here]({{&lt; relref &quot;/docs/blended_container.md&quot; &gt;}}) all modules that require configuration should be able to use external configuration files containing place holders to specify lookups from environment variables or resolve encrypted values.</p><p>For example, the configuration for an LDAP service might be:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">{</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  url             : &quot;ldaps://ldap.$[[env]].$[[country]]:4712&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  systemUser&quot;     : &quot;admin&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  systemPassword&quot; : &quot;$[(encrypted)[5c4e48e1920836f68f1abbaf60e9b026]]&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  userBase&quot;       : &quot;o=employee&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  userAttribute&quot;  : &quot;uid&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  groupBase&quot;      : &quot;ou=sib,ou=apps,o=global&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  groupAttribute&quot; : &quot;cn&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  groupSearch&quot;    : &quot;(member={0})&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The ZIO ecosystem has a library called <a href="https://zio.github.io/zio-config/" target="_blank" rel="noopener noreferrer">zio-config</a> which supports different sources such as property files, HOCON, YAML or even the command line. At the core of the library are ConfigDescriptors which can be used to read the config information into config case classes. The descriptors are also used to generate documentation for the available config options or reports over the configuration values used within the application.</p><p>Following the <a href="https://discord.com/channels/629491597070827530/633028431000502273/767663251092930591" target="_blank" rel="noopener noreferrer">advice</a> from the zio-config library author on discord, we introduce a <code>LazyConfigString</code> as follows:</p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Descriptor</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">sealed abstract case class LazyConfigString(value: String)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">object LazyConfigString {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  final case class Raw(raw: String) {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def evaluate(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      ctxt: Map[String, String]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ): ZIO[StringEvaluator.StringEvaluator, EvaluatorException, LazyConfigString] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      se  &lt;- ZIO.service[StringEvaluator.Service]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      res &lt;- se.resolveString(raw, ctxt)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield (new LazyConfigString(res) {})</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  val configString: ConfigDescriptor[Raw]               =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    string(Raw.apply, Raw.unapply)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def configString(path: String): ConfigDescriptor[Raw] = nested(path)(configString)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Essentially we define a class <code>LazyConfigString</code>, which instances will eventually hold the resolved config value. Making the class <code>sealed</code> and <code>abstract</code> ensures that new instances can only bo created from within the companion object.</p><p>Within the companion object the case class <code>Raw</code> can be instantiated with Strings read from the config sources. Also, within this class the <code>evaluate</code> method holds the effect describing the resolution of the raw config string to a real value. Essentially we are deferring the resolution to a <code>StringEvaluator</code> service.</p><p>At last we need to provide a config descriptor for <code>LazyConfigStrings</code>, so that the generated documentation will reflect that the config values are subject to lazy evaluation.</p><p>Using the <code>LazyConfigString</code>, we can define the <code>LDAPConfig</code> as follows:</p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Sample Config Descriptor</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">object LDAPConfig {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  import LazyConfigString._</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def desc: ConfigDescriptor[LDAPConfig] = (</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    configString(&quot;url&quot;) ?? &quot;The url to connect to the LDAP server&quot; |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;systemUser&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;systemPassword&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;userBase&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;userAttribute&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;groupBase&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;groupAttribute&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;groupSearch&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  )(LDAPConfig.apply, LDAPConfig.unapply)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">case class LDAPConfig(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  url: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  systemUser: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  systemPassword: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  userBase: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  userAttribute: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  groupBase: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  groupAttribute: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  groupSearch: LazyConfigString.Raw</span></div><div class="token-line" style="color:#403f53"><span class="token plain">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>To access a config value, a layer with a <code>StringEvaluator</code> must be referenced:</p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Access Config</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private val desc: ConfigDescriptor[LDAPConfig] = LDAPConfig.desc</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private val ctxt: Map[String, String]          = Map(&quot;user&quot; -&gt; &quot;ADMIN&quot;, &quot;env&quot; -&gt; &quot;dev&quot;, &quot;country&quot; -&gt; &quot;es&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private def simpleEval(src: ConfigSource) = testM(&quot;Evaluate a simple config map&quot;)(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    (for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      cfg &lt;- ZIO.fromEither(read(desc.from(src)))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      pwd &lt;- cfg.systemPassword.evaluate(ctxt)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield assert(pwd.value)(equalTo(&quot;blended&quot;))).provideLayer(evalLayer)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>With the code above, zio-config will generate the following report in markdown format:</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="field-descriptions"></a>Field Descriptions<a class="hash-link" href="#field-descriptions" title="Direct link to heading">#</a></h3><table><thead><tr><th>FieldName</th><th>Format</th><th>Description</th><th>Sources</th></tr></thead><tbody><tr><td>url</td><td>primitive</td><td>lazyly evaluated config string, The url to connect to the LDAP server</td><td></td></tr><tr><td>systemUser</td><td>primitive</td><td>lazyly evaluated config string</td><td></td></tr><tr><td>systemPassword</td><td>primitive</td><td>lazyly evaluated config string</td><td></td></tr><tr><td>userBase</td><td>primitive</td><td>lazyly evaluated config string</td><td></td></tr><tr><td>userAttribute</td><td>primitive</td><td>lazyly evaluated config string</td><td></td></tr><tr><td>groupBase</td><td>primitive</td><td>lazyly evaluated config string</td><td></td></tr><tr><td>groupAttribute</td><td>primitive</td><td>lazyly evaluated config string</td><td></td></tr><tr><td>groupSearch</td><td>primitive</td><td>lazyly evaluated config string</td><td></td></tr></tbody></table></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="evaluate-simple-string-expressions"></a>Evaluate simple string expressions<a class="hash-link" href="#evaluate-simple-string-expressions" title="Direct link to heading">#</a></h2><p>Lazy evaluated string expressions are simple expressions as defined here:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">sealed trait StringExpression</span></div><div class="token-line" style="color:#403f53"><span class="token plain">case class SimpleExpression(value: String)                                      extends StringExpression</span></div><div class="token-line" style="color:#403f53"><span class="token plain">case class SequencedExpression(parts: Seq[StringExpression])                    extends StringExpression</span></div><div class="token-line" style="color:#403f53"><span class="token plain">case class ModifierExpression(modStrings: Seq[String], inner: StringExpression) extends StringExpression</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The notable piece here is the <code>ModifierExpression</code>, which has the form</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">$[modifier*[StringExpression]]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>A modifier expression contains an inner expression and evaluation will be from the innermost expression outwards. After resolving the inner expression, zero or more modifiers will be applied to the resolved value for a given context. The context is a simple <code>Map[String, String]</code> and the normal resolution simply maps the resolved expression to the corresponding value in the map.</p><p>For example, the expression <code>$[[foo]]</code> with the context map <code>Map(&quot;foo&quot; -&gt; &quot;bar&quot;)</code> will yield <code>&quot;bar&quot;</code>.</p><p>Modifiers will be applied to the value resolved from the context map, for example with the context map from above</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">$[(upper)[foo]] =&gt; &quot;BAR&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">$[(left:2)[foo]] =&gt; &quot;ba&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Modifiers are specified as:</p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Modifier</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">trait Modifier {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def name: String</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def op(s: String, p: String): ZIO[Any, Throwable, String]</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def lookup: Boolean = true</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  final def modifier(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    s: String,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    p: String</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ): ZIO[Any, ModifierException, String] = (for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    input &lt;- ZIO.fromOption(Option(s))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    param  = Option(p).getOrElse(&quot;&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    mod   &lt;- op(input, param)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  } yield mod).mapError {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    case me: ModifierException =&gt; me</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    case t: Throwable          =&gt; new ModifierException(this, s, p, t.getMessage)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    case _                     =&gt; new ModifierException(this, &quot;&quot;, p, &quot;Segment can&#x27;t be null&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>A modifier implementation can override <code>lookup</code> to avoid that the value resolved from the inner expression will be used to look up the final value from the context map.</p><p>The <code>EncryptModifier</code> does that, so that the decryption will be applied to the string resolved from the inner expression.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="simple-crypto-service"></a>Simple crypto service<a class="hash-link" href="#simple-crypto-service" title="Direct link to heading">#</a></h2><p>The <code>EncryptModifier</code> is defined as</p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Decryption Modifier</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">object EncryptedModifier {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def create: ZIO[CryptoSupport.CryptoSupport, Nothing, Modifier] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    cs &lt;- ZIO.service[CryptoSupport.Service]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    mod = new Modifier {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            override def name: String = &quot;encrypted&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            override def lookup = false</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            override def op(s: String, p: String): ZIO[Any, Throwable, String] = (for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">              res &lt;- cs.decrypt(s)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            } yield (res))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  } yield mod</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>It relies on a crypto service available within the ZIO environment and simply delegates the resolution to the <code>decrypt</code> method of that service.</p><p>The crypto service is defined as</p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Simple Crypto Service</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  trait Service {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def encrypt(plain: String): ZIO[Any, CryptoException, String]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def decrypt(encrypted: String): ZIO[Any, CryptoException, String]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The default implementation can be instantiated with a password, for convenience the code also contains a default password. The password can also be provided via a file. Essentially, the provided password is used to generate a key that is then used to create an instance of a CryptoService which simply wraps some Crypto methods from Java:</p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Simple Crypto Service Implementation</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">final private class DefaultCryptoSupport(key: Key, alg: String) {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def decrypt(encrypted: String): ZIO[Any, CryptoException, String] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    bytes     &lt;- string2Byte(encrypted)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ciph      &lt;- cipher(Cipher.DECRYPT_MODE)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    decrypted &lt;- ZIO.effect(ciph.doFinal(bytes.toArray)).refineOrDie { case t =&gt; new CryptoFrameworkException(t) }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  } yield (new String(decrypted))</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def encrypt(plain: String): ZIO[Any, CryptoException, String] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ciph  &lt;- cipher(Cipher.ENCRYPT_MODE)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    bytes &lt;- ZIO.effect(ciph.doFinal(plain.getBytes())).refineOrDie { case t =&gt; new CryptoFrameworkException(t) }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    res   &lt;- byte2String(bytes.toSeq)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  } yield res</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private def cipher(mode: Int): ZIO[Any, CryptoException, Cipher] =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ZIO.effect { val res = Cipher.getInstance(alg); res.init(mode, key); res }.refineOrDie { case t =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      new CryptoFrameworkException(t)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    }</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private def byte2String(a: Seq[Byte]): ZIO[Any, Nothing, String] =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ZIO.collectPar(a)(b =&gt; ZIO.succeed(Integer.toHexString(b &amp; 0xff | 0x100).substring(1))).map(_.mkString)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private def string2Byte(s: String, orig: Option[String] = None): ZIO[Any, CryptoException, Seq[Byte]] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    val radix: Int = 16</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    (s match {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      case &quot;&quot;                               =&gt; ZIO.succeed(Seq.empty)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      case single if (single.length() == 1) =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        ZIO.effect(Seq(Integer.parseInt(single, radix).toByte)).refineOrDie { case _: NumberFormatException =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          new InvalidInputException(orig.getOrElse(s))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      case s                                =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        string2Byte(s.substring(2), Some(orig.getOrElse(s)))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          .map(rest =&gt; Seq(Integer.parseInt(s.substring(0, 2), radix).toByte) ++ rest)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    })</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="using-the-services"></a>Using the services<a class="hash-link" href="#using-the-services" title="Direct link to heading">#</a></h2><p>To use the services resolving config string, a layer with all required services must be provided:</p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Layer Provisioning</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private val logSlf4j = Slf4jLogger.make((_, message) =&gt; message)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private val cryptoDefault: ZLayer[Any, Nothing, CryptoSupport.CryptoSupport] =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    CryptoSupport.default.orDie</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private val mods: ZIO[Any, Nothing, Seq[Modifier]] = EncryptedModifier.create.provideLayer(cryptoDefault).map { em =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    Seq(UpperModifier, LowerModifier, em)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private val evalLayer: ZLayer[Any, Nothing, StringEvaluator.StringEvaluator] =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    logSlf4j &gt;&gt;&gt; StringEvaluator.fromMods(mods)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This layer can be provided to an effect by the means of <code>provideLayer</code></p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Layer Access</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private val desc: ConfigDescriptor[LDAPConfig] = LDAPConfig.desc</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private val ctxt: Map[String, String]          = Map(&quot;user&quot; -&gt; &quot;ADMIN&quot;, &quot;env&quot; -&gt; &quot;dev&quot;, &quot;country&quot; -&gt; &quot;es&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private def simpleEval(src: ConfigSource) = testM(&quot;Evaluate a simple config map&quot;)(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    (for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      cfg &lt;- ZIO.fromEither(read(desc.from(src)))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      pwd &lt;- cfg.systemPassword.evaluate(ctxt)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield assert(pwd.value)(equalTo(&quot;blended&quot;))).provideLayer(evalLayer)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Finally, the config can be resolved from a config source created from a <code>Map</code> with <code>ConfigSource.fromMap</code>:</p><div class="mdxCodeBlock_1zKU"><div style="color:#403f53;background-color:#FBFBFB" class="codeBlockTitle_2eSY">Sample config class</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">object LDAPConfig {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  import LazyConfigString._</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def desc: ConfigDescriptor[LDAPConfig] = (</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    configString(&quot;url&quot;) ?? &quot;The url to connect to the LDAP server&quot; |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;systemUser&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;systemPassword&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;userBase&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;userAttribute&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;groupBase&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;groupAttribute&quot;) |@|</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      configString(&quot;groupSearch&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  )(LDAPConfig.apply, LDAPConfig.unapply)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">case class LDAPConfig(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  url: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  systemUser: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  systemPassword: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  userBase: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  userAttribute: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  groupBase: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  groupAttribute: LazyConfigString.Raw,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  groupSearch: LazyConfigString.Raw</span></div><div class="token-line" style="color:#403f53"><span class="token plain">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blended-zio/docs/container"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Service based containers</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blended-zio/docs/jmx/index"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Blended ZIO JMX Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuring-blended-containers" class="table-of-contents__link">Configuring Blended Containers</a></li><li><a href="#evaluate-simple-string-expressions" class="table-of-contents__link">Evaluate simple string expressions</a></li><li><a href="#simple-crypto-service" class="table-of-contents__link">Simple crypto service</a></li><li><a href="#using-the-services" class="table-of-contents__link">Using the services</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blended-zio/docs/">Get Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/jaHWkWqn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://github.com/blended-zio/blended-zio/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blended-zio/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Way of Quality GmbH - Built with Docusaurus v2.</div></div></div></footer></div>
<script src="/blended-zio/styles.d9a0b84b.js"></script>
<script src="/blended-zio/runtime~main.29ca2af9.js"></script>
<script src="/blended-zio/main.7e8fceba.js"></script>
<script src="/blended-zio/1.19696370.js"></script>
<script src="/blended-zio/43.06c114df.js"></script>
<script src="/blended-zio/44.e6cb2f23.js"></script>
<script src="/blended-zio/935f2afb.5f2d17e5.js"></script>
<script src="/blended-zio/42.26aa1c8b.js"></script>
<script src="/blended-zio/18c3d7cc.6a65a9d1.js"></script>
</body>
</html>