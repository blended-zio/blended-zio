<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blended-zio/blog/rss.xml" title="Blended ZIO Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blended-zio/blog/atom.xml" title="Blended ZIO Blog Atom Feed"><title data-react-helmet="true">Keep alive for JMS connections | Blended ZIO</title><meta data-react-helmet="true" property="og:title" content="Keep alive for JMS connections | Blended ZIO"><meta data-react-helmet="true" name="description" content="This article concludes the mini series exploring the ZIO Stream API and shows how a simple keepalive mechanism can be added to a JMS based stream. This will check the health of the underlying JMS connection and issue a connection restart if required."><meta data-react-helmet="true" property="og:description" content="This article concludes the mini series exploring the ZIO Stream API and shows how a simple keepalive mechanism can be added to a JMS based stream. This will check the health of the underlying JMS connection and issue a connection restart if required."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/blended-zio/img/favicon.ico"><link rel="stylesheet" href="/blended-zio/styles.b0c1b4e5.css">
<link rel="preload" href="/blended-zio/styles.d9a0b84b.js" as="script">
<link rel="preload" href="/blended-zio/runtime~main.d68c9abc.js" as="script">
<link rel="preload" href="/blended-zio/main.7e8fceba.js" as="script">
<link rel="preload" href="/blended-zio/1.19696370.js" as="script">
<link rel="preload" href="/blended-zio/2.6b244c8e.js" as="script">
<link rel="preload" href="/blended-zio/ccc49370.722bba64.js" as="script">
<link rel="preload" href="/blended-zio/b06cd00d.1b6f8a4b.js" as="script">
<link rel="preload" href="/blended-zio/843ee933.dd1e4cef.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/blended-zio/"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blended-zio/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blended-zio/blog">Blog</a><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/blended-zio/"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/blended-zio/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blended-zio/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a aria-current="page" class="sidebarItemLink_v5H9 sidebarItemLinkActive_1anX" href="/blended-zio/blog/zio-jms-keepalive">Keep alive for JMS connections</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/zio-streams-autorecover">Autorecovery for (JMS) Streams</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/zio-streams-jms">ZIO Streams and JMS</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/zio-logging">Use ZIO Logging</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">Keep alive for JMS connections</h1><div class="margin-vert--md"><time datetime="2020-11-05T00:00:00.000Z" class="blogPostDate_Ta7i">November 5, 2020 </time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/atooni" target="_blank" rel="noreferrer noopener">Andreas Gies</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>This article concludes the mini series exploring the ZIO Stream API and shows how a simple keepalive mechanism can be added to a JMS based stream. This will check the health of the underlying JMS connection and issue a connection restart if required. </p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="why-do-we-need-a-keep-alive"></a>Why do we need a keep alive<a class="hash-link" href="#why-do-we-need-a-keep-alive" title="Direct link to heading">#</a></h1><p>In our existing application we have noticed that in some circumstances a connection that still exists and is reported as <code>connected</code> within the monitoring tools does not work as expected. In the case of JMS this usually happens when a particular connection is only used to receive messages. The connection may appear as <code>connected</code> and also have associated JMS sessions and consumers, but still will not receive any messages from the JMS broker.</p><p>Many JMS providers have implemented a keep alive mechanism, but in practice those have been proven to be somewhat difficult:</p><ul><li>They do not work in some edge cases such as restarting network switches on WAN connections.</li><li>They are not part of the JMS specification and therefore will be different from vendor to vendor and are definitely not mandatory.</li><li>They usually require some vendor specific code to be configured (if not configured via properties over JNDI).</li></ul><p>A connection which is also used to produce messages normally does require a keep alive monitor because it would encounter a <code>JMSException</code> when sends are attempted over a stale connection and therefore the connection could be recovered during normal error handling.</p><p>In this article I will pick up from the <a href="/blended-zio/blog/zio-streams-autorecover">last article</a>, where I investigated how we could leverage the ZIO Api to automatically recover from an exception in the JMS layer without terminating the ZIO stream with an exception.</p><p>We will show a simple keep alive monitor, which doesn&#x27;t know anything about JMS or streams at all. Then we will create an instance of that monitor watching a created JMS connection issuing a reconnect once the maximum number of missed keep alive events is reached.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>The complete source code used in this article can be found on <a href="https://github.com/blended-zio/blended-zio/tree/main/blended.zio.streams" target="_blank" rel="noopener noreferrer">github</a></p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="references-to-related-posts"></a>References to related posts<a class="hash-link" href="#references-to-related-posts" title="Direct link to heading">#</a></h2><ul><li><a href="/blended-zio/blog/zio-streams-jms">Basic streams with JMS</a></li><li><a href="/blended-zio/blog/zio-streams-autorecover">Auto Recovery for ZIO streams</a></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="a-simple-keep-alive-monitor"></a>A simple Keep Alive monitor<a class="hash-link" href="#a-simple-keep-alive-monitor" title="Direct link to heading">#</a></h2><p>A keep alive monitor is more or less a counter that is increased at certain intervals. It can be reset by sending it <code>alive</code> signals. Whenever
the counter reaches a defined value <code>n</code> that practically means that for <code>n * interval</code> the monitor hasn&#x27;t received a signal. The monitor as such does
not need to know about the entity it monitors, in our case the JMS connection.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">trait KeepAliveMonitor {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  /**</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   * An id to identify the monitor in the logs and metrics.</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   */</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  val id: String</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  /**</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   * The maximum number of allowed missed keep alive signals.</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   */</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  val allowed: Int</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  /**</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   * Signal that the monitored entity is still alive. This will cause to reset the missed</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   * counter to 0.</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   */</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def alive: ZIO[Logging, Nothing, Unit]</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  /**</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   * Start the monitor with a given interval. At every interval tick the counter</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   * for missed keep alives will be incremented. If the counter reaches the maximum allowed</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   * missed keep alives, run will terminate and yield the current counter (which happens to</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   * be the allowed maximum).</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   */</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def run(interval: Duration): ZIO[Clock with Logging, Nothing, Unit]</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  /**</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   * Return the current count of missed keep alives</span></div><div class="token-line" style="color:#403f53"><span class="token plain">   */</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def current: ZIO[Any, Nothing, Int]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The implementation for this interface is fairly straight forward. Within the <code>run</code> method we execute a step effect, which simply increases the internal
counter. If the counter has reached the given maximum, the step function terminates, otherwise the next step is scheduled after the given interval.</p><p>Overall, <code>run</code> will terminate once the given max count has been reached. Therefore it is always a good idea fo users of the monitor to execute <code>monitor.run</code> in it&#x27;s own fiber.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private[streams] def run(interval: Duration): ZIO[Clock with Logging, Nothing, Unit] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def go: ZIO[Clock, Nothing, Unit] = ZIO.ifM(missed.updateAndGet(_ + 1).map(_ == allowedKeepAlives))(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      ZIO.unit,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      go.schedule(Schedule.duration(interval)).flatMap(_ =&gt; ZIO.unit)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    )</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _ &lt;- log.trace(s&quot;Starting KeepAliveMonitor [$name]&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _ &lt;- go.schedule(Schedule.duration(interval))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      c &lt;- missed.get</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _ &lt;- log.trace(s&quot;KeepAliveMonitor [$name] finished with maximum keep alives of [$c]&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="using-the-keep-alive-monitor-with-jms-connections"></a>Using the Keep alive monitor with JMS connections<a class="hash-link" href="#using-the-keep-alive-monitor-with-jms-connections" title="Direct link to heading">#</a></h2><p>With the JMS based streams explained <a href="/blended-zio/blog/zio-streams-jms">here</a> and the general keep alive monitor we can now build a monitor that determines whether a given JMS connection is healthy. We do that by using the connection to be monitored and regularly send and receive messages. Whenever a message is received, we execute <code>alive</code> on the underlying monitor - effectively resetting the counter.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="definining-a-keep-alive-sink"></a>Definining a Keep alive Sink<a class="hash-link" href="#definining-a-keep-alive-sink" title="Direct link to heading">#</a></h3><p>From the API perspective we want to create a stream that regularly creates messages and run that with a JMS sink - effectively sending the messages to the JMS broker.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private def startKeepAliveSender(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    con: JmsConnection,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    dest: JmsDestination,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    interval: Duration</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ): ZIO[ZEnv with Logging, JMSException, Unit] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    val stream: ZStream[ZEnv, Nothing, String] = ZStream</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      .fromSchedule(Schedule.spaced(interval))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      .mapM(_ =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        currentTime(TimeUnit.MILLISECONDS)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          .map(t =&gt; s&quot;KeepAlive ($con) : ${sdf.format(t)}&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      )</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    createSession(con).use(jmsSess =&gt; createProducer(jmsSess).use(prod =&gt; stream.run(jmsSink(prod, dest))))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>Keep in mind that the library has prototyping character for now, so some elements like the ping message format are hard coded for the time being and need to be fleshed out later on.</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="defining-a-keep-alive-stream"></a>Defining a Keep alive Stream<a class="hash-link" href="#defining-a-keep-alive-stream" title="Direct link to heading">#</a></h3><p>Now we need to define a consumer - in other words a ZIO stream - and for each message received we want to execute <code>alive</code> on a given <code>KeepAliveMonitor</code>.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private def startKeepAliveReceiver(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    con: JmsConnection,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    dest: JmsDestination,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    kam: KeepAliveMonitor</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ): ZIO[ZEnv with Logging, JMSException, Unit] = createSession(con).use { jmsSess =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    createConsumer(jmsSess, dest).use(cons =&gt; jmsStream(cons).foreach(_ =&gt; kam.alive))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="create-the-jms-keep-alive-monitor"></a>Create the JMS Keep Alive Monitor<a class="hash-link" href="#create-the-jms-keep-alive-monitor" title="Direct link to heading">#</a></h3><p>The JMS keep alive monitor will be created once a connection configured with monitoring is established. We also need a destination that shall be used for sending and receiving the keep alive messages, an interval and the maximum allowed missed keep alives.</p><p>With those parameters the JMS keep alive monitor is straight forward:</p><ol><li>Create an an instance of a general <code>KeepAliveMonitor</code></li><li>Start the sink for keep alives</li><li>Start the stream to receive keep alives</li><li>Fork the run method of the just created monitor</li><li>Once run terminates, interrupt the stream and sink</li><li>Terminate with the current count of the underlying monitor</li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  def run(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    con: JmsConnection,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    dest: JmsDestination,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    interval: Duration,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    allowed: Int</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ): ZIO[ZEnv with Logging with ZIOJmsConnectionManager, JMSException, Int] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    kam  &lt;- DefaultKeepAliveMonitor.make(s&quot;${con.id}-KeepAlive&quot;, allowed)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    send &lt;- startKeepAliveSender(con, dest, interval).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    rec  &lt;- startKeepAliveReceiver(con, dest, kam).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    f    &lt;- kam.run(interval).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    _    &lt;- f.join</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    _    &lt;- send.interrupt *&gt; rec.interrupt</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    c    &lt;- kam.current</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  } yield (c)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="instrumenting-a-jms-connection-with-a-keep-alive-monitor"></a>Instrumenting a JMS connection with a keep alive monitor<a class="hash-link" href="#instrumenting-a-jms-connection-with-a-keep-alive-monitor" title="Direct link to heading">#</a></h2><p>The API has a case class exposed for a JMS connection:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">final case class JmsConnectionFactory(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  override val id: String,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  factory: ConnectionFactory,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  reconnectInterval: Duration,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  onConnect: JmsConnection =&gt; ZIO[ZEnv with Logging, Nothing, Unit] = _ =&gt; ZIO.unit</span></div><div class="token-line" style="color:#403f53"><span class="token plain">) extends JmsApiObject {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def connId(clientId: String): String = s&quot;$id-$clientId&quot;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>In here we see that the case class also contains an effect which will be executed every time a physical connection to the JMS broker has been established. This effect takes the <code>JMSConnection</code> as a parameter. We can now use <code>onConnect</code> to set up the keep alive monitor.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private def keepAlive(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    conMgr: SingletonService[ZIOJmsConnectionManager.Service]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ): JmsConnection =&gt; ZIO[ZEnv with Logging, Nothing, Unit] = { c =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    val ka = ZIO</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      .ifM(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        JmsKeepAliveMonitor</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          .run(c, JmsQueue(&quot;keepAlive&quot;), 1.second, 3)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          .map(_ == allowedKeepAlives)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      )(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        reconnect(c, Some(new KeepAliveException(c.id, allowedKeepAlives))),</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        ZIO.unit</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      )</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    val monitor: ZIO[ZEnv with Logging with ZIOJmsConnectionManager.ZIOJmsConnectionManager, JMSException, Unit] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      f &lt;- ka.fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _ &lt;- log.trace(s&quot;Waiting for keep alive monitor for [$c]&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _ &lt;- f.join</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    val effect = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      // We need to specify the left over !!!</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _ &lt;- monitor.provideSomeLayer[ZEnv with Logging](ZIOJmsConnectionManager.Service.live(conMgr)).forkDaemon</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    effect</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Let&#x27;s break this down a bit:</p><ul><li><p>First we run an instance of the <code>JMSKeepAliveMonitor</code> which either terminates when the maximum number of missed keep alives has been reached or the application terminates. In the first case we need to issue a reconnect on the JMS connection using an underlying connection manager.</p></li><li><p>Then we wrap running the monitor in it&#x27;s own fiber and wait for it to terminate.</p></li><li><p>The final step is perhaps a bit confusing, the case class defines <code>onConnect</code> to require an environment <code>[ZEnv with Logging]</code>, but using <code>reconnect</code> also requires a <code>ZIOJMSConnectionManager</code> to be present in the environment. Therefore we pass a <code>SingletonService[ZIOJmsConnectionManager.Service]</code> as a parameter to the <code>keepAlive</code> method.</p><p> We can the use <code>provideSomeLayer</code> to provide the connection manager to the <code>JMSKeepAliveMonitor</code> and we are left with an effect that requires only <code>[ZEnv with Logging]</code> which is what we need to fulfill the API.</p></li></ul><p>With the keepAlive method in place we can now create the connection factory. Again, we see an instance of the connection manager service passed through.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private def amqCF(si: SingletonService[ZIOJmsConnectionManager.Service]): JmsConnectionFactory = JmsConnectionFactory(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    &quot;amq:amq&quot;,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    new ActiveMQConnectionFactory(&quot;vm://simple?create=false&quot;),</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    3.seconds,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    keepAlive(si)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-program-to-be-run"></a>The program to be run<a class="hash-link" href="#the-program-to-be-run" title="Direct link to heading">#</a></h2><p>First of all we need to create an instance of a <code>ZIOJmsConnectionManager.Service</code>. This instance is then passed to the actual logic, so that the keep alive monitor can use it to inject it into the environment of <code>JMSKeepAliveMonitor.run</code>. The instance is also required by the logic effect itself, otherwise the connections could not be established to create the streams and sinks.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private val program: ZIO[ZEnv with AMQBroker.AMQBroker with Logging, Throwable, ExitCode] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def logic(si: SingletonService[ZIOJmsConnectionManager.Service]) = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _         &lt;- putStrLn(&quot;Starting JMS Broker&quot;) *&gt; ZIO.service[BrokerService]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      f         &lt;- ZIO.unit.schedule(Schedule.duration(30.minutes)).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      jmsStream &lt;- recoveringJmsStream(amqCF(si), clientId, testDest, 2.seconds)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      jmsSink   &lt;- recoveringJmsSink(amqCF(si), clientId, testDest, 1.second)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      consumer  &lt;- jmsStream.foreach(s =&gt; putStrLn(s)).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      producer  &lt;- stream.run(jmsSink).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _         &lt;- f.join &gt;&gt;&gt; consumer.interrupt &gt;&gt;&gt; producer.interrupt</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      si &lt;- ZIOJmsConnectionManager.Service.singleton</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _  &lt;-</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        logic(si).provideSomeLayer[ZEnv with AMQBroker.AMQBroker with Logging](ZIOJmsConnectionManager.Service.live(si))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield ExitCode.success</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The <code>SingletonService</code> here simply encapsulates a reference to an <code>Option[A]</code> and an effect to create an <code>A</code> to create an <code>A</code> upon the first retrieval. Other retrievals will simply reuse the instance created before.</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>Using the Singleton is an antipattern and the connection manager will be refactored not to use it in future versions. </p></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">package blended.zio.streams</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">import zio._</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">private[streams] trait SingletonService[A] {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private[streams] val instance: Ref[Option[A]]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private[streams] def makeService: ZIO[Any, Nothing, A]</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private[streams] def service: ZIO[Any, Nothing, A] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    sr  &lt;- instance.get</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    svc &lt;- sr match {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">             case Some(s) =&gt; ZIO.succeed(s)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">             case None    =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">               for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                 s &lt;- makeService</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                 _ &lt;- instance.set(Some(s))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">               } yield s</span></div><div class="token-line" style="color:#403f53"><span class="token plain">           }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  } yield (svc)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">object SingletonService {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  def fromEffect[A](e: ZIO[Any, Nothing, A]): ZIO[Any, Nothing, SingletonService[A]] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    inst &lt;- Ref.make[Option[A]](None)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    svc   = new SingletonService[A] {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">              override private[streams] val instance    = inst</span></div><div class="token-line" style="color:#403f53"><span class="token plain">              override private[streams] def makeService = e</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  } yield (svc)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">}</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The <code>ZIOJmsConnectionManager</code> uses the <code>SingletonService</code> as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">    val singleton: ZIO[Any, Nothing, SingletonService[Service]] =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      SingletonService.fromEffect(createLive)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def live(s: SingletonService[Service]): ZLayer[Any, Nothing, ZIOJmsConnectionManager] = ZLayer.fromEffect(s.service)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>We have added a simple keep alive mechanism to the JMS connections we have discussed in the previous articles. The keep alive build on the streams with
auto recovery and triggers a reconnect once a limit of maximum missed keep alives has been reached. The reconnect then triggers the recovery and reconnect as defined for auto recovery.</p><p>For the users of the stream the keep alive and potential reconnect is completely transparent. Further, the <code>onConnect</code> effect would allow us to instrument the connection factory with other effects - for example to collect metrics or publish JMX information.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="next-steps"></a>Next steps<a class="hash-link" href="#next-steps" title="Direct link to heading">#</a></h2><p>Apart from finalizing the API there are more areas to explore:</p><ul><li>Use defined types rather than only String as message payloads.</li><li>Support arbitrary message properties.</li><li>Look into defining message flows on top of streams with error handling and acknowledgements.</li><li>Explore <a href="https://github.com/zio/zio-zmx" target="_blank" rel="noopener noreferrer">zio-zmx</a> to visualize the current state of all fibers within a running application (for learning about threads primarily)</li><li>Build a sample application that represents a JMS bridge<ul><li>Consume message from provider A</li><li>Send the message to provider B</li><li>Acknowledge the message if and only if the send was successful, otherwise pass the message to a retry handler</li><li>Replay messages from the retry handler up to a given retry count until the send was successful. If the maximum retries have been reached or a given amount of time has passed before the send was successful, the message shall be processed by an error handler.</li><li>Messages in the retry handler shall be persisted and survive an application restart.</li></ul></li></ul></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blended-zio/blog/tags/zio">ZIO</a><a class="margin-horiz--sm" href="/blended-zio/blog/tags/streams">Streams</a><a class="margin-horiz--sm" href="/blended-zio/blog/tags/jms">JMS</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blended-zio/blog/zio-streams-autorecover"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Autorecovery for (JMS) Streams Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#references-to-related-posts" class="table-of-contents__link">References to related posts</a></li><li><a href="#a-simple-keep-alive-monitor" class="table-of-contents__link">A simple Keep Alive monitor</a></li><li><a href="#using-the-keep-alive-monitor-with-jms-connections" class="table-of-contents__link">Using the Keep alive monitor with JMS connections</a><ul><li><a href="#definining-a-keep-alive-sink" class="table-of-contents__link">Definining a Keep alive Sink</a></li><li><a href="#defining-a-keep-alive-stream" class="table-of-contents__link">Defining a Keep alive Stream</a></li><li><a href="#create-the-jms-keep-alive-monitor" class="table-of-contents__link">Create the JMS Keep Alive Monitor</a></li></ul></li><li><a href="#instrumenting-a-jms-connection-with-a-keep-alive-monitor" class="table-of-contents__link">Instrumenting a JMS connection with a keep alive monitor</a></li><li><a href="#the-program-to-be-run" class="table-of-contents__link">The program to be run</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li><li><a href="#next-steps" class="table-of-contents__link">Next steps</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blended-zio/docs/">Get Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/jaHWkWqn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://github.com/blended-zio/blended-zio/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blended-zio/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Way of Quality GmbH - Built with Docusaurus v2.</div></div></div></footer></div>
<script src="/blended-zio/styles.d9a0b84b.js"></script>
<script src="/blended-zio/runtime~main.d68c9abc.js"></script>
<script src="/blended-zio/main.7e8fceba.js"></script>
<script src="/blended-zio/1.19696370.js"></script>
<script src="/blended-zio/2.6b244c8e.js"></script>
<script src="/blended-zio/ccc49370.722bba64.js"></script>
<script src="/blended-zio/b06cd00d.1b6f8a4b.js"></script>
<script src="/blended-zio/843ee933.dd1e4cef.js"></script>
</body>
</html>