<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blended-zio/blog/rss.xml" title="Blended ZIO Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blended-zio/blog/atom.xml" title="Blended ZIO Blog Atom Feed"><title data-react-helmet="true">Autorecovery for (JMS) Streams | Blended ZIO</title><meta data-react-helmet="true" property="og:title" content="Autorecovery for (JMS) Streams | Blended ZIO"><meta data-react-helmet="true" name="description" content="Today we are going to explore the ZIO streams API and see how we can create a stream that will will enter a recovery phase in certain error scenarios. We will explore how we can deal with exceptions on the connection level while keeping the stream processing code untouched."><meta data-react-helmet="true" property="og:description" content="Today we are going to explore the ZIO streams API and see how we can create a stream that will will enter a recovery phase in certain error scenarios. We will explore how we can deal with exceptions on the connection level while keeping the stream processing code untouched."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/blended-zio/img/favicon.ico"><link rel="stylesheet" href="/blended-zio/styles.b0c1b4e5.css">
<link rel="preload" href="/blended-zio/styles.ff7a30a6.js" as="script">
<link rel="preload" href="/blended-zio/runtime~main.3abbd089.js" as="script">
<link rel="preload" href="/blended-zio/main.f40baaf4.js" as="script">
<link rel="preload" href="/blended-zio/1.c3df032e.js" as="script">
<link rel="preload" href="/blended-zio/2.13b555c9.js" as="script">
<link rel="preload" href="/blended-zio/ccc49370.1fd3518b.js" as="script">
<link rel="preload" href="/blended-zio/b06cd00d.bcfd189f.js" as="script">
<link rel="preload" href="/blended-zio/c197126e.2ac3ee6c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/blended-zio/"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blended-zio/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blended-zio/blog">Blog</a><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/blended-zio/"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/blended-zio/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blended-zio/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/integration-testing">Integration Testing</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/zio-jms-keepalive">Keep alive for JMS connections</a></li><li class="sidebarItem_2T0D"><a aria-current="page" class="sidebarItemLink_v5H9 sidebarItemLinkActive_1anX" href="/blended-zio/blog/zio-streams-autorecover">Autorecovery for (JMS) Streams</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/zio-streams-jms">ZIO Streams and JMS</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/zio-logging">Use ZIO Logging</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">Autorecovery for (JMS) Streams</h1><div class="margin-vert--md"><time datetime="2020-10-30T00:00:00.000Z" class="blogPostDate_Ta7i">October 30, 2020 </time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/atooni" target="_blank" rel="noreferrer noopener">Andreas Gies</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Today we are going to explore the ZIO streams API and see how we can create a stream that will will enter a recovery phase in certain error scenarios. We will explore how we can deal with exceptions on the connection level while keeping the stream processing code untouched.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="automatically-recover-jms-streams"></a>Automatically recover (JMS) streams<a class="hash-link" href="#automatically-recover-jms-streams" title="Direct link to heading">#</a></h1><p>In my last <a href="/blended-zio/blog/zio-streams-jms">article</a> I have shown how the ZIO stream API allows us to easily create streams for sending or receiving messages via JMS. Within the sample program we have seen that the streams terminate with an exception whenever the underlying JMS API raises encounters an error.</p><p>One of the most common errors is that the connection is lost due to a network error. For long running applications we would like to initiate an automatic reconnect and either create a new stream or recover the existing stream. The advantage of recovering the existing stream is that we do not have to rewire the users of the streams. Any effect using the existing stream will be suspended until the reconnect has happened and then continue.</p><p>In this article I will explore how we ca use the ZIO API to achieve such a transparent reconnect.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>The complete source code used in this article can be found on <a href="https://github.com/blended-zio/blended-zio/tree/main/blended.zio.streams" target="_blank" rel="noopener noreferrer">github</a></p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-we-want-to-achieve"></a>What we want to achieve<a class="hash-link" href="#what-we-want-to-achieve" title="Direct link to heading">#</a></h2><p>Like in the last article, let&#x27;s start by looking at a sample program we would like to run:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private val program: ZIO[ZEnv with AMQBroker.AMQBroker with Logging, Throwable, Unit] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    val logic = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      mgr       &lt;- ZIO.service[ZIOJmsConnectionManager.Service]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _         &lt;- putStrLn(&quot;Starting JMS Broker&quot;) *&gt; ZIO.service[BrokerService]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      f         &lt;- ZIO.unit.schedule(Schedule.duration(30.seconds)).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _         &lt;-</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        mgr.reconnect(amqCF.connId(clientId), Some(new Exception(&quot;Boom&quot;))).schedule(Schedule.duration(10.seconds)).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      jmsStream &lt;- recoveringJmsStream(amqCF, clientId, testDest, 2.seconds)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      jmsSink   &lt;- recoveringJmsSink(amqCF, clientId, testDest, 1.second)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      consumer  &lt;- jmsStream.foreach(s =&gt; putStrLn(s)).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      producer  &lt;- stream.run(jmsSink).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _         &lt;- f.join &gt;&gt;&gt; consumer.interrupt &gt;&gt;&gt; producer.interrupt</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      si &lt;- ZIOJmsConnectionManager.Service.singleton</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _  &lt;- logic.provideSomeLayer[ZEnv with AMQBroker.AMQBroker with Logging](ZIOJmsConnectionManager.Service.live(si))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>There are 2 important differences in comparison to the sample application of the last article:</p><ol><li>We are issuing a reconnect to the underlying connection factory. This implies that there is some mechanism within the connection factory that controls an automated reconnect.</li><li>Rather than creating the JMS stream / sink directly we use an effect that yields a <strong>factory</strong> linked to the connection factory which can create a stream or sink for a given destination.</li></ol><p>When we run this program with the input stream below, we will notice that the output pauses for a couple of seconds when the reconnect is triggered and then continues sending and receiving messages.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private val stream: ZStream[ZEnv, Nothing, String] = ZStream</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .fromSchedule(Schedule.spaced(1000.millis).jittered)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .mapM(_ =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      currentTime(TimeUnit.MILLISECONDS)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        .map(sdf.format)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Here is an excerpt from the console output:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-07.13.52.817</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-07.13.54.631</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-07.13.54.985  &lt;----- NOTE THE GAP</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-07.13.58.952  &lt;----- NOTE THE GAP</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-07.13.59.095</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-07.13.59.955</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="a-reconnecting-wrapper-around-the-jms-connection-factory"></a>A reconnecting wrapper around the JMS Connection factory<a class="hash-link" href="#a-reconnecting-wrapper-around-the-jms-connection-factory" title="Direct link to heading">#</a></h2><p>Under the covers we use a connection factory that lifts all JMS related calls to ZIO effects. Further, an established connection will be reused as much as possible - effectively limiting the number of connections per connection factory to at most 1.</p><p>To achieve this, we wrap the connect method into a Semaphore and return the connection if it already exists, otherwise we create a new connection and store it.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">      private[jms] def connect(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        cf: JmsConnectionFactory,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        clientId: String</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      ): ZIO[ZEnv with Logging, JMSException, JmsConnection] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        val cid = cf.connId(clientId)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        sem.withPermit(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            con &lt;- for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                     cr &lt;- getConnection(cid)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                     c  &lt;- ZIO.fromOption(cr).orElse(checkedConnect(cf, clientId))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                   } yield c</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          } yield con</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        )</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>To recover a connection, we perform a JMS close on the existing connect and enter a recovery period. Within that period any execution of the <code>connect</code> effect will result in a <code>JMSException</code>.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">      private def recover(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        c: JmsConnection,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        t: Option[Throwable]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      ): ZIO[ZEnv with Logging, JMSException, Unit] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        _ &lt;- close(c)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        _ &lt;- scheduleRecover(c.factory, c.clientId, t)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      private def scheduleRecover(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        cf: JmsConnectionFactory,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        clientId: String,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        t: Option[Throwable]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      ): ZIO[ZEnv with Logging, Nothing, Unit] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        val cid = cf.connId(clientId)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        ZIO.ifM(getConnection(cid).map(_.isDefined))(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          ZIO.unit,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            _ &lt;-</span></div><div class="token-line" style="color:#403f53"><span class="token plain">              log.debug(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                s&quot;Beginning recovery period for [$cid]&quot; + t.map(c =&gt; s&quot; , cause [${c.getMessage}]&quot;).getOrElse(&quot;&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">              )</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            _ &lt;- recovering.update(r =&gt; cid :: r)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            f &lt;- recovering.update(_.filterNot(_ == cid)).schedule(Schedule.duration(cf.reconnectInterval)).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            _ &lt;- f.join</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            _ &lt;- log.debug(s&quot;Ending recovery period for [$cid]&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        )</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      }</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      private def checkedConnect(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        cf: JmsConnectionFactory,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        clientId: String</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      ): ZIO[ZEnv with Logging, JMSException, JmsConnection] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        val cid = cf.connId(clientId)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        ZIO.ifM(isRecovering(cid))(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          ZIO.fail(new JMSException(s&quot;Connection factory [$cid] is in recovery&quot;)),</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">            c &lt;- doConnect(cf, clientId)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          } yield c</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        )</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Finally, the <code>reconnect</code>effect simply triggers the recover if an underlying connection currently exists.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">      private[jms] def reconnect(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        con: JmsConnection,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        cause: Option[Throwable]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      ): ZIO[ZEnv with Logging, JMSException, Unit] = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        _  &lt;- log.debug(s&quot;Reconnecting JMS connection [$con]&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        cr &lt;- getConnection(con.id)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        _  &lt;- cr match {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                case None    =&gt; ZIO.unit</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                case Some(c) =&gt; recover(c, cause)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">              }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      } yield ()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="creating-a-recoverable-stream-consume-messages"></a>Creating a recoverable Stream (consume messages)<a class="hash-link" href="#creating-a-recoverable-stream-consume-messages" title="Direct link to heading">#</a></h2><p>The idea behind the recovering stream is that we connect to the JMS broker with the given connection factory and then start consuming messages until we hit an exception. Whenever we hit an exception, we catch it and enter a recovery phase. After the recovery phase we will try to reconnect and continue to consume messages.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  def stream(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    dest: JmsDestination</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ): ZIO[ZEnv with Logging with ZIOJmsConnectionManager, Nothing, ZStream[ZEnv with Logging, Nothing, String]] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def consumeUntilException(cons: JmsConsumer): ZIO[ZEnv with Logging, JMSException, Unit] = jmsStream(cons).collect {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      case tm: TextMessage =&gt; tm.getText()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      .foreach(s =&gt; buffer.offer(s))</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def consumeForEver: ZIO[ZEnv with Logging with ZIOJmsConnectionManager, Nothing, Unit] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      val part = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        _   &lt;- log.debug(s&quot;Trying to recover consumer for [${factory.id}] with destination [$dest]&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        con &lt;- connect(factory, clientId)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        _   &lt;- createSession(con).use(jmsSess =&gt; createConsumer(jmsSess, dest).use(c =&gt; consumeUntilException(c)))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      part.catchAll { _ =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          f &lt;- consumeForEver.schedule(Schedule.duration(retryInterval)).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          _ &lt;- f.join</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    }</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _ &lt;- consumeForEver.fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      s &lt;- ZIO.succeed(ZStream.repeatEffect(buffer.take))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield s</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The idea manifests in <code>consumeUntilException</code> and <code>consumeForEver</code>. <code>consumeUntilException</code> uses the stream we have seen in the last [article]({{&lt; relref &quot;/posts/2020-10-27-ZIOJms.md#receiving-messages&quot; &gt;}}). It will stick all messages that have been received into a one element buffer which we can use later on to create the final stream visible to the outside world.</p><p><code>consumeForever</code> simply creates an effect which will cerate the JMS connection and then delegate to <code>consumeUntilException</code>. The we apply the <code>catchAll</code> operator to that effect where we schedule the next iteration to <code>consumeForEver</code> after a recovery period.</p><p>The final stream is then created from repeating the <code>take</code> operation of the buffer while <code>consumerForEver</code> is executing in it&#x27;s own fiber.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="why-a-one-element-buffer-"></a>Why a one element buffer ?<a class="hash-link" href="#why-a-one-element-buffer-" title="Direct link to heading">#</a></h3><p>One might wonder why I am using a one element buffer. We are operating on JMS and want to make sure that no messages are being lost. As a result, in a real application we have to acknowledge the message to the message broker once we are done with processing it. In case we encounter an exception while processing the message we have several options:</p><ol><li>We drop the message byt acknowledging even if we could not process it correctly</li><li>We forward the message to another destination such as an error destination or a retry destination and acknowledge it</li><li>We deny the message</li></ol><p>The last option here is not really part of the JMS API which only has an acknowledge method on the JMS message. What we would do in a real application is use a session with <code>CLIENT_ACKNOWLEDGE</code> and to deny the message we would close the receiving session. This would automatically mark the message as undelivered in the JMS broker - effectively denying the message. As this would apply to all messages that have been received within the same session and that have not been acknowledged yet, we consume the messages one by one.</p><p>We will explore the error handling further in another post.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="creating-a-recoverable-sink-send-messages"></a>Creating a recoverable Sink (send messages)<a class="hash-link" href="#creating-a-recoverable-sink-send-messages" title="Direct link to heading">#</a></h2><p>The idea behind the recovering sink is pretty much the same as for the recovering stream. The subtle difference is that we do not use the sink we have seen in the last <a href="/blended-zio/blog/zio-streams-jms">article</a>, but a method to send a single message.</p><p>Apart from that, the pattern to create the recoverable sink is the same as for creating the stream.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  def sink(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    dest: JmsDestination,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    retryInterval: Duration</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ): ZIO[</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ZEnv with Logging with ZIOJmsConnectionManager,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    Nothing,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ZSink[ZEnv with Logging, Nothing, String, String, Unit]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def produceOne(p: JmsProducer): ZIO[ZEnv with Logging, JMSException, Unit] = buffer.take.flatMap { s: String =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      send(s, p, dest)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    }</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    def produceForever: ZIO[ZEnv with Logging with ZIOJmsConnectionManager, Nothing, Unit] = {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      val part = for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        _   &lt;- log.debug(s&quot;Trying to recover producer for [${factory.id}] with destination [$dest]&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        con &lt;- connect(factory, clientId)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        _   &lt;- createSession(con).use { jmsSess =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                 createProducer(jmsSess).use { p =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                   for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                     f &lt;- produceOne(p).forever.fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                     _ &lt;- f.join</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                   } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                 }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">               }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      part.catchAll { _ =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          f &lt;- produceForever.schedule(Schedule.duration(retryInterval)).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          _ &lt;- f.join</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    }</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _ &lt;- produceForever.fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      s &lt;- ZIO.succeed(ZSink.foreach(msg =&gt; buffer.offer(msg)))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield s</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="sample-log"></a>Sample log<a class="hash-link" href="#sample-log" title="Direct link to heading">#</a></h2><p>Below is a log excerpt of the sample app execution. Note the disconnect starting time <code>10770</code>, the recovery period of the connection and the recurring recovery attempts of the consumer and producer stream until the reconnect has finished and everything can resume from <code>16550</code> onwards.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">--- Entries omitted</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.49.397 |     9458 | DEBUG : Received [Some(ActiveMQTextMessage {commandId = 37, responseRequired = true, messageId = ID:ToonBox-46199-1604041900408-4:1:1:1:16, originalDestination = null, originalTransactionId = null, producerId = ID:ToonBox-46199-1604041900408-4:1:1:1, destination = queue://sample, transactionId = null, expiration = 0, timestamp = 1604041909396, arrival = 0, brokerInTime = 1604041909396, brokerOutTime = 1604041909397, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 1070, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, jmsXGroupFirstForConsumer = false, text = 2020-10-30-08.11.49.396})] with [JmsConsumer((amq:amq)(sampleCon)-(S-1604041900731-1)-(C-1)-sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.005 |    10066 | DEBUG : Message [2020-10-30-08.11.50.004] sent successfully with [JmsProducer((amq:amq)(sampleCon)-(S-1604041900731-2)-P-1)] to [sample]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.005 |    10066 | DEBUG : Received [Some(ActiveMQTextMessage {commandId = 39, responseRequired = true, messageId = ID:ToonBox-46199-1604041900408-4:1:1:1:17, originalDestination = null, originalTransactionId = null, producerId = ID:ToonBox-46199-1604041900408-4:1:1:1, destination = queue://sample, transactionId = null, expiration = 0, timestamp = 1604041910004, arrival = 0, brokerInTime = 1604041910004, brokerOutTime = 1604041910005, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 1070, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, jmsXGroupFirstForConsumer = false, text = 2020-10-30-08.11.50.004})] with [JmsConsumer((amq:amq)(sampleCon)-(S-1604041900731-1)-(C-1)-sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.684 |    10745 | DEBUG : Message [2020-10-30-08.11.50.683] sent successfully with [JmsProducer((amq:amq)(sampleCon)-(S-1604041900731-2)-P-1)] to [sample]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.684 |    10745 | DEBUG : Received [Some(ActiveMQTextMessage {commandId = 41, responseRequired = true, messageId = ID:ToonBox-46199-1604041900408-4:1:1:1:18, originalDestination = null, originalTransactionId = null, producerId = ID:ToonBox-46199-1604041900408-4:1:1:1, destination = queue://sample, transactionId = null, expiration = 0, timestamp = 1604041910683, arrival = 0, brokerInTime = 1604041910683, brokerOutTime = 1604041910684, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 1070, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, jmsXGroupFirstForConsumer = false, text = 2020-10-30-08.11.50.683})] with [JmsConsumer((amq:amq)(sampleCon)-(S-1604041900731-1)-(C-1)-sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.709 |    10770 | INFO  : Connector vm://simple stopped</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.710 |    10771 | DEBUG : Closed [((amq:amq)(sampleCon))]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.717 |    10778 | DEBUG : Beginning recovery period for [(amq:amq)] , cause [Boom]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.720 |    10781 | WARN  : Error receiving message with [JmsConsumer((amq:amq)(sampleCon)-(S-1604041900731-1)-(C-1)-sample)] : [The Consumer is closed]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.763 |    10824 | DEBUG : Closing Consumer [JmsConsumer((amq:amq)(sampleCon)-(S-1604041900731-1)-(C-1)-sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.50.767 |    10828 | DEBUG : Closing JMS Session [((amq:amq)(sampleCon)-(S-1604041900731-1))]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.51.442 |    11503 | WARN  : Error sending message with [JmsProducer((amq:amq)(sampleCon)-(S-1604041900731-2)-P-1)] to [JmsQueue(sample)]: [The Session is closed]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.51.451 |    11512 | DEBUG : Closing JMS Producer [JmsProducer((amq:amq)(sampleCon)-(S-1604041900731-2)-P-1)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.51.455 |    11516 | DEBUG : Closing JMS Session [((amq:amq)(sampleCon)-(S-1604041900731-2))]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.52.459 |    12520 | DEBUG : Trying to recover producer for [(amq:amq)] with [JmsQueue(sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.52.771 |    12832 | DEBUG : Trying to recover consumer for [(amq:amq)] with destination [JmsQueue(sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.53.464 |    13525 | DEBUG : Trying to recover producer for [(amq:amq)] with [JmsQueue(sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.54.467 |    14528 | DEBUG : Trying to recover producer for [(amq:amq)] with [JmsQueue(sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.54.774 |    14835 | DEBUG : Trying to recover consumer for [(amq:amq)] with destination [JmsQueue(sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.55.470 |    15531 | DEBUG : Trying to recover producer for [(amq:amq)] with [JmsQueue(sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.55.773 |    15834 | DEBUG : Ending recovery period for [(amq:amq)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.472 |    16533 | DEBUG : Trying to recover producer for [(amq:amq)] with [JmsQueue(sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.474 |    16535 | DEBUG : Connecting [(amq:amq)] with clientId [sampleCon]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.475 |    16536 | INFO  : Connector vm://simple started</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.486 |    16547 | DEBUG : Created [((amq:amq)(sampleCon))]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.489 |    16550 | DEBUG : Created JMS Producer [JmsProducer((amq:amq)(sampleCon)-(S-1604041916487-1)-P-1)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.492 |    16553 | DEBUG : Message [2020-10-30-08.11.51.895] sent successfully with [JmsProducer((amq:amq)(sampleCon)-(S-1604041916487-1)-P-1)] to [sample]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.493 |    16554 | DEBUG : Message [2020-10-30-08.11.52.295] sent successfully with [JmsProducer((amq:amq)(sampleCon)-(S-1604041916487-1)-P-1)] to [sample]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.776 |    16837 | DEBUG : Trying to recover consumer for [(amq:amq)] with destination [JmsQueue(sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.781 |    16842 | DEBUG : Created JMS Consumer [JmsConsumer((amq:amq)(sampleCon)-(S-1604041916777-2)-(C-1)-sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.782 |    16843 | DEBUG : Received [Some(ActiveMQTextMessage {commandId = 5, responseRequired = true, messageId = ID:ToonBox-46199-1604041900408-4:2:1:1:1, originalDestination = null, originalTransactionId = null, producerId = ID:ToonBox-46199-1604041900408-4:2:1:1, destination = queue://sample, transactionId = null, expiration = 0, timestamp = 1604041916490, arrival = 0, brokerInTime = 1604041916490, brokerOutTime = 1604041916779, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 1070, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, jmsXGroupFirstForConsumer = false, text = 2020-10-30-08.11.51.895})] with [JmsConsumer((amq:amq)(sampleCon)-(S-1604041916777-2)-(C-1)-sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.56.783 |    16844 | DEBUG : Received [Some(ActiveMQTextMessage {commandId = 6, responseRequired = true, messageId = ID:ToonBox-46199-1604041900408-4:2:1:1:2, originalDestination = null, originalTransactionId = null, producerId = ID:ToonBox-46199-1604041900408-4:2:1:1, destination = queue://sample, transactionId = null, expiration = 0, timestamp = 1604041916492, arrival = 0, brokerInTime = 1604041916493, brokerOutTime = 1604041916780, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 1070, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, jmsXGroupFirstForConsumer = false, text = 2020-10-30-08.11.52.295})] with [JmsConsumer((amq:amq)(sampleCon)-(S-1604041916777-2)-(C-1)-sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.57.123 |    17184 | DEBUG : Message [2020-10-30-08.11.57.122] sent successfully with [JmsProducer((amq:amq)(sampleCon)-(S-1604041916487-1)-P-1)] to [sample]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">2020-10-30-08:11.57.123 |    17184 | DEBUG : Received [Some(ActiveMQTextMessage {commandId = 11, responseRequired = true, messageId = ID:ToonBox-46199-1604041900408-4:2:1:1:3, originalDestination = null, originalTransactionId = null, producerId = ID:ToonBox-46199-1604041900408-4:2:1:1, destination = queue://sample, transactionId = null, expiration = 0, timestamp = 1604041917122, arrival = 0, brokerInTime = 1604041917122, brokerOutTime = 1604041917123, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 1070, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, jmsXGroupFirstForConsumer = false, text = 2020-10-30-08.11.57.122})] with [JmsConsumer((amq:amq)(sampleCon)-(S-1604041916777-2)-(C-1)-sample)]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">--- Entries omitted</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>With very little code and simple patterns we could create ZIO streams on top of JMS with automatic recovery baked in. Towards the users of the created stream or sink the recovery is completely transparent and from their perspective they are working with normal <code>ZStream</code>s or <code>ZSink</code>s.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="next-steps"></a>Next steps<a class="hash-link" href="#next-steps" title="Direct link to heading">#</a></h2><p>The next step is to add a keep alive monitor to an established connection, which will trigger reconnects if a maximum number of keep alive messages have been missed.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blended-zio/blog/tags/zio">ZIO</a><a class="margin-horiz--sm" href="/blended-zio/blog/tags/streams">Streams</a><a class="margin-horiz--sm" href="/blended-zio/blog/tags/jms">JMS</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blended-zio/blog/zio-jms-keepalive"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Keep alive for JMS connections</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blended-zio/blog/zio-streams-jms"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">ZIO Streams and JMS Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-we-want-to-achieve" class="table-of-contents__link">What we want to achieve</a></li><li><a href="#a-reconnecting-wrapper-around-the-jms-connection-factory" class="table-of-contents__link">A reconnecting wrapper around the JMS Connection factory</a></li><li><a href="#creating-a-recoverable-stream-consume-messages" class="table-of-contents__link">Creating a recoverable Stream (consume messages)</a><ul><li><a href="#why-a-one-element-buffer-" class="table-of-contents__link">Why a one element buffer ?</a></li></ul></li><li><a href="#creating-a-recoverable-sink-send-messages" class="table-of-contents__link">Creating a recoverable Sink (send messages)</a></li><li><a href="#sample-log" class="table-of-contents__link">Sample log</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li><li><a href="#next-steps" class="table-of-contents__link">Next steps</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blended-zio/docs/">Get Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/jaHWkWqn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://github.com/blended-zio/blended-zio/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blended-zio/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Way of Quality GmbH - Built with Docusaurus v2.</div></div></div></footer></div>
<script src="/blended-zio/styles.ff7a30a6.js"></script>
<script src="/blended-zio/runtime~main.3abbd089.js"></script>
<script src="/blended-zio/main.f40baaf4.js"></script>
<script src="/blended-zio/1.c3df032e.js"></script>
<script src="/blended-zio/2.13b555c9.js"></script>
<script src="/blended-zio/ccc49370.1fd3518b.js"></script>
<script src="/blended-zio/b06cd00d.bcfd189f.js"></script>
<script src="/blended-zio/c197126e.2ac3ee6c.js"></script>
</body>
</html>