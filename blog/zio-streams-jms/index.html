<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blended-zio/blog/rss.xml" title="Blended ZIO Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blended-zio/blog/atom.xml" title="Blended ZIO Blog Atom Feed"><title data-react-helmet="true">ZIO Streams and JMS | Blended ZIO</title><meta data-react-helmet="true" property="og:title" content="ZIO Streams and JMS | Blended ZIO"><meta data-react-helmet="true" name="description" content="In this article we are going to explore a bit of the ZIO streams API and how it can be used to talk to a JMS broker. The ZIO web site and awesome-zio have a lot of very good articles and talks on ZIO streams covering the basics, so I won&#x27;t repeat those here."><meta data-react-helmet="true" property="og:description" content="In this article we are going to explore a bit of the ZIO streams API and how it can be used to talk to a JMS broker. The ZIO web site and awesome-zio have a lot of very good articles and talks on ZIO streams covering the basics, so I won&#x27;t repeat those here."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/blended-zio/img/favicon.ico"><link rel="stylesheet" href="/blended-zio/styles.b0c1b4e5.css">
<link rel="preload" href="/blended-zio/styles.da6d526b.js" as="script">
<link rel="preload" href="/blended-zio/runtime~main.44b07677.js" as="script">
<link rel="preload" href="/blended-zio/main.d1c2779d.js" as="script">
<link rel="preload" href="/blended-zio/1.9a06b93b.js" as="script">
<link rel="preload" href="/blended-zio/2.a102c19c.js" as="script">
<link rel="preload" href="/blended-zio/3.97404501.js" as="script">
<link rel="preload" href="/blended-zio/ccc49370.3d27b053.js" as="script">
<link rel="preload" href="/blended-zio/e6d99264.b8e665dd.js" as="script">
<link rel="preload" href="/blended-zio/d1e3202f.a88e4cc6.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/blended-zio/"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blended-zio/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blended-zio/blog">Blog</a><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/blended-zio/"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blended-zio/img/Logos/svg/black_no_background.svg" alt="Blended ZIO" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/blended-zio/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blended-zio/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/doc-helpers">Documentation Helpers</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/integration-testing">Integration Testing</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/zio-jms-keepalive">Keep alive for JMS connections</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blended-zio/blog/zio-streams-autorecover">Autorecovery for (JMS) Streams</a></li><li class="sidebarItem_2T0D"><a aria-current="page" class="sidebarItemLink_v5H9 sidebarItemLinkActive_1anX" href="/blended-zio/blog/zio-streams-jms">ZIO Streams and JMS</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">ZIO Streams and JMS</h1><div class="margin-vert--md"><time datetime="2020-10-27T00:00:00.000Z" class="blogPostDate_Ta7i">October 27, 2020 </time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/atooni" target="_blank" rel="noreferrer noopener">Andreas Gies</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>In this article we are going to explore a bit of the ZIO streams API and how it can be used to talk to a JMS broker. The <a href="https://zio.dev/docs/resources/resources" target="_blank" rel="noopener noreferrer">ZIO web site</a> and <a href="https://github.com/aparo/awesome-zio" target="_blank" rel="noopener noreferrer">awesome-zio</a> have a lot of very good articles and talks on ZIO streams covering the basics, so I won&#x27;t repeat those here.</p><p>For this article I have used an embedded <a href="https://activemq.apache.org/" target="_blank" rel="noopener noreferrer">ActiveMQ</a> messaging broker, but the code makes no assumptions about the underlying JMS provider. Usually the JMS broker would run externally and we would use a provider specific connection factory to connect to it.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>The complete source code used in this article can be found on <a href="https://github.com/blended-zio/blended-zio/tree/main/blended.zio.streams" target="_blank" rel="noopener noreferrer">github</a></p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-we-want-to-achieve"></a>What we want to achieve<a class="hash-link" href="#what-we-want-to-achieve" title="Direct link to heading">#</a></h2><p>Let&#x27;s start by considering what a simple program sending and receiving messages from an ActiveMQ broker would look like. That program should be runnable as normal ZIO app:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private val program =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _      &lt;- putStrLn(&quot;Starting JMS Broker&quot;) *&gt; ZIO.service[BrokerService]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      conMgr &lt;- ZIO.service[ZIOJmsConnectionManager.Service]</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      _      &lt;- (for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                  con &lt;- conMgr.connect(cf, &quot;sample&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                  _   &lt;- conMgr.reconnect(con, Some(new Exception(&quot;Boom&quot;))).schedule(Schedule.duration(10.seconds)).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                  _   &lt;- for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                           c &lt;- consumer(con).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                           p &lt;- producer(con).fork</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                           _ &lt;- c.join</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                           _ &lt;- p.join</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                         } yield ()</span></div><div class="token-line" style="color:#403f53"><span class="token plain">                } yield ())</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    } yield ()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>We can see from <code>program</code>&#x27;s type that besides the ZIO environment <code>ZEnv</code> we will need an ActiveMQ message broker and also the <a href="https://zio.github.io/zio-logging/" target="_blank" rel="noopener noreferrer">ZIO logging API</a> to execute the program. With those requirements the program is fairly straightforward:</p><ol><li>aquire the message broker from the environment</li><li>create a connection factory to talk to the broker just started</li><li>create a fiber that simply sits in the background for 10 seconds</li><li>use the connection factory to establish a JMS connection</li><li>use the connection to kick off a sender and receiver</li><li>join with the timed fiber to interrupt the sender and receiver</li><li>clean up the connection</li></ol><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>The sample program has a scheduled <code>reconnect</code> after 10 seconds. This will cause the execution to fail with an exception because the underlying streams terminate with a <code>JMSException</code>. In one of the next articles I will get into stream recovery.</p></div></div><p>We will dive into the various steps throughout the remainder of this article to see how ZIO is helping to provide a smooth access to JMS. First, let&#x27;s see how we can run the program above:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  override def run(args: List[String]): ZIO[ZEnv, Nothing, ExitCode] = program</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .provideCustomLayer(combinedEnv)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .catchAllCause(c =&gt; putStrLn(c.prettyPrint))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .exitCode</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As we can see, we need to provide the environment with all required services, so that the <code>program</code> can actually execute.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="constructing-the-environment"></a>Constructing the Environment<a class="hash-link" href="#constructing-the-environment" title="Direct link to heading">#</a></h2><p>First, we create a layer which consist of the standard ZIO environment enriched with the Slf4j implementation of the <code>Logging</code> service. This layer is required by the ActiveMQ service implementation and also by the program itself.</p><p>Next we create the ActiveMQ service using vertical composition with the <code>logEnv</code> and also an instance of a <code>ZIOJmsConnectionManager</code> which we stick into the environment as well.</p><p>Finally we can create the <code>combinedEnv</code> using horizontal composition of the logging, the broker layer and the connection manager layer.</p><p>The resulting environments contains everything to run our program.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private val logEnv: ZLayer[Any, Nothing, ZEnv with Logging] =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ZEnv.live ++ Slf4jLogger.make((_, message) =&gt; message)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private val brokerEnv: ZLayer[Any, Throwable, AMQBroker.AMQBroker] =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    logEnv &gt;&gt;&gt; AMQBroker.simple(&quot;simple&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private val mgrEnv = ZIOJmsConnectionManager.Service.make</span></div><div class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  private val combinedEnv =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    logEnv ++ brokerEnv ++ mgrEnv</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>For reference, the Active MQ broker service is <a href="https://github.com/blended-zio/blended-zio-activemq/blob/main/blended-zio-activemq/src/main/scala/blended/zio/activemq/AMQBroker.scala" target="_blank" rel="noopener noreferrer">here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="sending-messages"></a>Sending messages<a class="hash-link" href="#sending-messages" title="Direct link to heading">#</a></h2><p>To have some data travelling the message broker, let&#x27;s start by creating a plain ZIO stream, which emits a String element every half second or so. Each element is simply the current time formatted using a <code>SimpleDateFormat</code>.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private val stream: ZStream[ZEnv, Nothing, String] = ZStream</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .fromSchedule(Schedule.spaced(500.millis).jittered)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    .mapM(_ =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      currentTime(TimeUnit.MILLISECONDS)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        .map(sdf.format)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Now we want to send all these Strings to JMS and later on receive them.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private def producer(con: JmsConnection) =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    createSession(con).use(session =&gt; createProducer(session).use(prod =&gt; stream.run(jmsSink(prod, testDest))))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The send is broken down into these steps:</p><ol><li>create the JMS session</li><li>create the JMS MessageProducer</li><li>use the producer to create a ZIO Sink</li><li>run the stream with the sink, so that the generated messages aresent to JMS</li></ol><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Within the JMS API we use a number of <a href="https://github.com/blended-zio/blended-zio/blob/main/blended.zio.streams/src/main/scala/blended/zio/streams/jms/jmsobjects.scala" target="_blank" rel="noopener noreferrer">case classes</a> that are simple wrappers around the underlying JMS classes. Essentially these case classes contain some additional information besides the original object. For one, we keep a reference of the instance that was used as a factory. I.e. the <code>JmsSession</code> has a reference to the connection it belongs to and a <code>JmsConsumer</code> a reference to the <code>JmsSession</code> it was created for.</p><p>Besides that all classes contain a human readable identifier, which is mainly used to produce a more readable log.</p></div></div><p>Having this in mind, we create a named JMS session as a <code>ZManaged</code>, so that ZIO takes care of closing the session after it has been used. Within the session we create a <code>JmsProducer</code>, which is again a <code>ZManaged</code>.</p><p>Note, that the producer does not actually <em>produce</em> the messages in the sense of JMS - it just has all the information to do so.</p><p>So, let&#x27;s have a look how we can define an effect using the poducer to actually send a message:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  def send(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    text: String,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    prod: JmsProducer,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    dest: JmsDestination</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ) = (for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    msg &lt;- effectBlocking(prod.session.session.createTextMessage(text))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    d   &lt;- dest.create(prod.session)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    _   &lt;- effectBlocking(prod.producer.send(d, msg))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    _   &lt;- log.debug(s&quot;Message [$text] sent successfully with [$prod] to [${dest.asString}]&quot;)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  } yield ()).flatMapError { t =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    log.warn(s&quot;Error sending message with [$prod] to [$dest]: [${t.getMessage()}]&quot;) *&gt; ZIO.succeed(t)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }.refineOrDie { case t: JMSException =&gt; t }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ol><li>use the producer&#x27;s session to create the JMS <code>Message</code> object</li><li>use the producer&#x27;s session to create the JMS <code>Destination</code> object</li><li>perform the JMS send</li><li>record the send in the log</li></ol><p>Now that we have the effect sending a single message, we can easily create a sink. The <code>ZSink</code> object in the ZIO streams API has a <code>foreach</code> method, which allows us to create a sink from an effect:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">// in ZSink:</span></div><div class="token-line" style="color:#403f53"><span class="token plain">def foreach[R, E, I](f: I =&gt; ZIO[R, E, Any]): ZSink[R, E, I, I, Unit]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Let&#x27;s take a moment to digest the signature: <code>R</code> and <code>E</code> is the usual type magic within ZIO to describe the environment required for the sink and the errors it may produce. <code>Unit</code> in that case means that the final result after running a Stream with this Sink is <code>Unit</code>. In other words, the Stream is just run for the effect passed in as a parameter.</p><p>The function provided needs to create an effect for each element of type <code>I</code>.</p><p>In our case we already have the effect, which is the <code>send</code> method above, so we can define our sink as</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  def jmsSink(</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    prod: JmsProducer,</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    dest: JmsDestination</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  ) =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ZSink.foreach[ZEnv with Logging with ZIOJmsConnectionManager, JMSException, String](s =&gt; send(s, prod, dest))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="receiving-messages"></a>Receiving messages<a class="hash-link" href="#receiving-messages" title="Direct link to heading">#</a></h2><p>Now let&#x27;s understand the <code>consumer</code> of our program:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  private def consumer(con: JmsConnection) =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    createSession(con).use { session =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      createConsumer(session, testDest).use { cons =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">        jmsStream(cons).collect { case m: TextMessage =&gt; m.getText() }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">          .foreach(s =&gt; putStrLn(s))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">      }</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Again, we need to create a <code>JmsSession</code>, but this time we use it to create a <code>JmsConsumer</code> for the given <code>JmsDestination</code>.
We then use the created consumer to create a <code>ZStream[R, E, Message]</code>, in other words a plain <code>ZStream</code> of JMS <code>Message</code> objects. From that stream we collect all <code>TextMessage</code> instances, get the <code>String</code> body of those and print that to the console.</p><p>Creating the stream is again amazingly simple with the ZIO streams API:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  def jmsStream(cons: JmsConsumer) =</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    ZStream.repeatEffect(receive(cons)).collect { case Some(s) =&gt; s }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>We repeat an effect producing optional <code>Message</code> objects (optional because the underlying receive yields <code>None</code> if no message is available for the consumer). As we are only interested in the actual messages, we collect only the results actually having a <code>Message</code>.</p><p>The actual consume is simply a wrapper around the JMS API with some logging:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-scala codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#403f53;background-color:#FBFBFB"><div class="token-line" style="color:#403f53"><span class="token plain">  def receive(cons: JmsConsumer) = (for {</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    msg &lt;- effectBlocking(Option(cons.consumer.receiveNoWait()))</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    _   &lt;- if (msg.isDefined) log.debug(s&quot;Received [$msg] with [$cons]&quot;) else ZIO.unit</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  } yield msg).flatMapError { t =&gt;</span></div><div class="token-line" style="color:#403f53"><span class="token plain">    log.warn(s&quot;Error receiving message with [$cons] : [${t.getMessage()}]&quot;) *&gt; ZIO.succeed(t)</span></div><div class="token-line" style="color:#403f53"><span class="token plain">  }.refineOrDie { case t: JMSException =&gt; t }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="next-steps"></a>Next steps<a class="hash-link" href="#next-steps" title="Direct link to heading">#</a></h2><p>I have not elaborated too much on the underlying <code>ZIOJmsConnectionManager</code>. Essentially this is a map to hold named connection factories. At the moment the connection manager guarantees that for a given id only one physical JMS connection is created. Also, the connection manager will provide automated reconnects and connection monitoring, which we will look at in later articles.</p><p>Next I will explore how to enhance the demo program with some resilience. The idea here is to create <em>self healing</em> streams that would automatically reconnect after a connection has been lost.</p><p>For now I have just used Strings as message objects; this will be enhanced to more flexible and useful messages.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>With ZIO it is very straight forward to break down a given problem into smaller pieces and then use those as building blocks for the solution. The challenge for developer like me is to get the head around the signatures and how all the types play together.</p><p>For example, building the environment took me a couple of hours to get it right. One has to take the time to read and understand the compiler errors. In the end I found that these errors pretty much tell me what I need to put together in terms of hirzontal and vertical composition to get it right.</p><p>The first steps in some areas of ZIO require quite a bit of code study. Given that ZIO is just beyond it&#x27;s first official release, the documentation and other resources are plenty, but scattered araound talks and blogs. The <a href="https://www.zionomicon.com/" target="_blank" rel="noopener noreferrer">upcoming book by John De Goes and Adam Fraser</a> adresses a lot of that and already has a lot of content in it&#x27;s alpha version.</p><p>Even if it means stating the obvious: Also when you work with a more sophisticated API in ZIO in the inner layers you are going to find ZIO effects which you then combine into something else - in our case create <code>ZStream</code> and <code>ZSink</code> from plain ZIO&#x27;s and then have the entire ZStream magic at the tip of your fingers to manipulate JMS streams.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blended-zio/blog/tags/zio">ZIO</a><a class="margin-horiz--sm" href="/blended-zio/blog/tags/streams">Streams</a><a class="margin-horiz--sm" href="/blended-zio/blog/tags/jms">JMS</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blended-zio/blog/zio-streams-autorecover"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Autorecovery for (JMS) Streams</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blended-zio/blog/zio-logging"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Use ZIO Logging Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-we-want-to-achieve" class="table-of-contents__link">What we want to achieve</a></li><li><a href="#constructing-the-environment" class="table-of-contents__link">Constructing the Environment</a></li><li><a href="#sending-messages" class="table-of-contents__link">Sending messages</a></li><li><a href="#receiving-messages" class="table-of-contents__link">Receiving messages</a></li><li><a href="#next-steps" class="table-of-contents__link">Next steps</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">About</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blended-zio/docs/andreas">Andreas Gies</a></li><li class="footer__item"><a class="footer__link-item" href="/blended-zio/docs/legal">Legal</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/jaHWkWqn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://github.com/blended-zio/blended-zio/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blended-zio/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/blended-zio/blended-zio" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Way of Quality GmbH - Built with Docusaurus v2.</div></div></div></footer></div>
<script src="/blended-zio/styles.da6d526b.js"></script>
<script src="/blended-zio/runtime~main.44b07677.js"></script>
<script src="/blended-zio/main.d1c2779d.js"></script>
<script src="/blended-zio/1.9a06b93b.js"></script>
<script src="/blended-zio/2.a102c19c.js"></script>
<script src="/blended-zio/3.97404501.js"></script>
<script src="/blended-zio/ccc49370.3d27b053.js"></script>
<script src="/blended-zio/e6d99264.b8e665dd.js"></script>
<script src="/blended-zio/d1e3202f.a88e4cc6.js"></script>
</body>
</html>